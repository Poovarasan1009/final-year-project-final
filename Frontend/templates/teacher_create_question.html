<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Question - Teacher Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .form-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .ideal-answer-box {
            min-height: 150px;
            border: 2px solid #0d6efd;
            border-radius: 10px;
            padding: 15px;
            font-size: 16px;
        }

        .preview-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #0d6efd;
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(90deg, #0d6efd, #0dcaf0);">
        <div class="container">
            <a class="navbar-brand" href="/teacher">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <span class="navbar-text">
                <i class="fas fa-chalkboard-teacher"></i> {{ teacher_name }}
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <h3 class="mb-4">
                    <i class="fas fa-plus-circle"></i> Create New Question
                </h3>

                <!-- Question Form -->
                <div class="form-section">
                    <form id="questionForm">
                        <!-- Question Text -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-question"></i> Question Text
                            </label>
                            <textarea class="form-control" id="questionText" rows="4" required
                                placeholder="Enter the descriptive question..."></textarea>
                        </div>

                        <!-- Subject & Topic -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Subject</label>
                                <select class="form-select" id="subject" required>
                                    <option value="">Select Subject</option>
                                    <option value="Computer Science">Computer Science</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="Physics">Physics</option>
                                    <option value="Chemistry">Chemistry</option>
                                    <option value="Biology">Biology</option>
                                    <option value="Environmental Science">Environmental Science</option>
                                    <option value="English">English</option>
                                    <option value="History">History</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Topic</label>
                                <input type="text" class="form-control" id="topic"
                                    placeholder="e.g., Machine Learning, Photosynthesis">
                            </div>
                        </div>

                        <!-- Difficulty & Marks -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Difficulty Level</label>
                                <select class="form-select" id="difficulty" required>
                                    <option value="easy">Easy</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Marks</label>
                                <input type="number" class="form-control" id="marks" value="10" min="1" max="100"
                                    required>
                            </div>
                        </div>

                        <!-- IDEAL ANSWER (MOST IMPORTANT) -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-star"></i> Ideal/Model Answer
                                <span class="text-danger">*</span>
                            </label>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                This is the answer students' responses will be evaluated against.
                                Make it comprehensive and accurate.
                            </div>
                            <div class="ideal-answer-box" contenteditable="true" id="idealAnswer"
                                placeholder="Type the ideal answer here..."></div>
                            <div class="char-count mt-2" id="idealCharCount">0 characters</div>
                        </div>

                        <!-- Keywords (Optional) -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-key"></i> Key Concepts (Optional)
                            </label>
                            <input type="text" class="form-control" id="keywords"
                                placeholder="Enter comma-separated keywords (e.g., photosynthesis, chloroplast, sunlight)">
                            <small class="text-muted">These help the AI understand important concepts</small>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> CREATE QUESTION
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Preview Section -->
                <div class="form-section">
                    <h5><i class="fas fa-eye"></i> Preview</h5>
                    <div class="preview-box">
                        <div id="questionPreview">
                            <p class="text-muted">Question preview will appear here...</p>
                        </div>

                        <div class="mt-3" id="answerPreview" style="display: none;">
                            <hr>
                            <h6><i class="fas fa-star text-warning"></i> Ideal Answer Preview:</h6>
                            <p id="idealAnswerPreview" class="mb-0"></p>
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="alert alert-warning">
                    <h6><i class="fas fa-lightbulb"></i> Tips for Creating Good Questions:</h6>
                    <ul class="mb-0">
                        <li>Make questions clear and unambiguous</li>
                        <li>Provide a comprehensive ideal answer covering all expected points</li>
                        <li>Specify marks based on question complexity</li>
                        <li>Include key concepts to help AI evaluation</li>
                        <li>Test the question yourself using the student portal</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Character count for ideal answer
        const idealAnswerBox = document.getElementById('idealAnswer');
        const idealCharCount = document.getElementById('idealCharCount');

        idealAnswerBox.addEventListener('input', function () {
            const text = this.textContent || this.innerText;
            const count = text.length;
            idealCharCount.textContent = `${count} characters`;

            // Update preview
            updatePreview();
        });

        // Set placeholder
        idealAnswerBox.setAttribute('data-placeholder', 'Type the ideal answer here...');

        // Update preview as user types
        document.getElementById('questionText').addEventListener('input', updatePreview);
        document.getElementById('subject').addEventListener('change', updatePreview);
        document.getElementById('topic').addEventListener('input', updatePreview);
        document.getElementById('difficulty').addEventListener('change', updatePreview);
        document.getElementById('marks').addEventListener('input', updatePreview);

        function updatePreview() {
            const questionText = document.getElementById('questionText').value;
            const subject = document.getElementById('subject').value;
            const topic = document.getElementById('topic').value;
            const difficulty = document.getElementById('difficulty').value;
            const marks = document.getElementById('marks').value;
            const idealAnswer = idealAnswerBox.textContent.trim();

            // Update question preview
            let previewHTML = '';

            if (questionText) {
                previewHTML += `<h6>Question:</h6><p>${questionText}</p>`;
            }

            if (subject || topic || difficulty || marks) {
                previewHTML += `<div class="d-flex gap-2">`;
                if (subject) previewHTML += `<span class="badge bg-secondary">${subject}</span>`;
                if (topic) previewHTML += `<span class="badge bg-info">${topic}</span>`;
                if (difficulty) {
                    const diffColor = difficulty === 'easy' ? 'success' :
                        difficulty === 'medium' ? 'warning' : 'danger';
                    previewHTML += `<span class="badge bg-${diffColor}">${difficulty.toUpperCase()}</span>`;
                }
                if (marks) previewHTML += `<span class="badge bg-primary">${marks} Marks</span>`;
                previewHTML += `</div>`;
            }

            document.getElementById('questionPreview').innerHTML = previewHTML ||
                '<p class="text-muted">Question preview will appear here...</p>';

            // Update ideal answer preview
            if (idealAnswer && idealAnswer !== idealAnswerBox.getAttribute('data-placeholder')) {
                document.getElementById('answerPreview').style.display = 'block';
                document.getElementById('idealAnswerPreview').textContent =
                    idealAnswer.length > 200 ? idealAnswer.substring(0, 200) + '...' : idealAnswer;
            } else {
                document.getElementById('answerPreview').style.display = 'none';
            }
        }

        // Handle form submission
        document.getElementById('questionForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const questionText = document.getElementById('questionText').value;
            const subject = document.getElementById('subject').value;
            const topic = document.getElementById('topic').value;
            const difficulty = document.getElementById('difficulty').value;
            const marks = document.getElementById('marks').value;
            const idealAnswer = idealAnswerBox.textContent.trim();

            // Validate
            if (!questionText) {
                alert('Please enter question text');
                return;
            }

            if (!subject) {
                alert('Please select a subject');
                return;
            }

            if (!idealAnswer || idealAnswer === idealAnswerBox.getAttribute('data-placeholder')) {
                alert('Please provide an ideal answer for evaluation');
                return;
            }

            if (idealAnswer.length < 20) {
                if (!confirm('Ideal answer seems very short. Are you sure?')) {
                    return;
                }
            }

            const keywords = document.getElementById('keywords').value;

            // Submit
            try {
                const response = await fetch('/api/teacher/create-question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'question_text': questionText,
                        'subject': subject,
                        'topic': topic,
                        'difficulty': difficulty,
                        'marks': marks,
                        'ideal_answer': idealAnswer,
                        'keywords': keywords
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Question created successfully!');
                    window.location.href = '/teacher';
                } else {
                    alert('Error: ' + (result.error || result.message || 'Unknown error'));
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Failed to create question. Please try again.');
            }
        });

        // Initialize preview
        updatePreview();
    </script>
</body>

</html>